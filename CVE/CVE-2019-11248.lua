SCAN_TYPE = 3
BODY_MATCH = {
    'Types of profiles available:',
    'Profile Descriptions',
    'goroutine profile: total'
}

local function send_report(resp)
    Reports:add{
        name = "CVE-2019-11248",
        description = "The debugging endpoint /debug/pprof is exposed over the unauthenticated Kubelet healthz port. This debugging endpoint can potentially leak sensitive information such as internal Kubelet memory addresses and configuration, or for limited denial of service. Versions prior to 1.15.0, 1.14.4, 1.13.8, and 1.12.10 are affected. The issue is of medium severity, but not exposed by the default configuration.",
        risk = "high",
        url = url,
        matches = {
            status_code = "200",
            body = {
                'Types of profiles available:',
                'Profile Descriptions',
                'goroutine profile: total'
            },
            full_response = show_response(resp)
        }
    }
end

local function scan_cve(target_path)
    local new_path = pathjoin(HttpMessage:path(), target_path)
    local new_url = HttpMessage:urljoin(new_path)
    local resp_status, resp = pcall(function()
        return http:send{url = new_url}
    end)
    if resp_status == true then
        local body = resp.body
        local body_match = Matcher:match_body(body, BODY_MATCH) -- Matching body with List with and conditions
        if resp.status ~= 200 then return end
        if body_match then send_report(resp) end
    end
end

function main()
    scan_cve("debug/pprof/goroutine?debug=1")
    scan_cve("debug/pprof/")
end
