-- AUTHOR: Mohamed Tarek @0xr00t3d
-- Reference: https://www.vmware.com/security/advisories/VMSA-2021-0010.html

SCAN_TYPE = 2

function scan_cve(path)
    local new_url = HttpMessage:urljoin(path)
    local headers = {}
    headers["Content-Type"] = "application/json"

    local status, resp = pcall(function()
        return http:send {
            method = "POST",
            url = new_url,
            headers = headers,
            body = [[
                    {"methodInput":[{"type":"ClusterComputeResource","value": null,"serverGuid": null}]}
                ]],

        }
    end)

    local body = resp["body"]

    if str_contains(body, '{"result":{"isDisconnected":') then
        scan_report(new_url)
    end

end

function scan_report(url)
    Reports:add {
        name = "CVE-2021-21985",
        url = url,
        risk = "critical",
        description =
        [[The vSphere Client (HTML5) contains a remote code execution vulnerability due to lack of input validation in the Virtual SAN Health Check plug-in which is enabled by default in vCenter Server. A malicious actor with network access to port 443 may exploit this issue to execute commands with unrestricted privileges on the underlying operating system that hosts vCenter Server.]],
    }
end

function main()
    scan_cve("vsan/rest/proxy/service/com.vmware.vsan.client.services.capability.VsanCapabilityProvider/getClusterCapabilityData")

end
