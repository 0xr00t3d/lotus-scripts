SCAN_TYPE = 3
BODY_MATCH = {
    'Axis2 Happiness Page',
    'Examining webapp configuration',
    'Essential Components'
}

local function send_report(resp)
    Reports:add{
        name = "CVE-2020-11450",
        description = "MicroStrategy Web 10.4 is susceptible to information disclosure. The JVM configuration, CPU architecture, installation folder, and other information are exposed through /MicroStrategyWS/happyaxis.jsp. An attacker can use this vulnerability to learn more about the application environment and thereby possibly obtain sensitive information, modify data, and/or execute unauthorized operations.",
        risk = "high",
        url = resp.url,
        matches = {
            status_code = "200",
            body = {
                'Axis2 Happiness Page',
                'Examining webapp configuration',
                'Essential Components'
            },
            full_response = show_response(resp)
        }
    }
end

local function scan_cve(target_path)
    local new_path = pathjoin(HttpMessage:path(), target_path)
    local new_url = HttpMessage:urljoin(new_path)
    local resp_status, resp = pcall(function()
        return http:send{url = new_url}
    end)
    if resp_status == true then
        local body = resp.body
        local body_match = Matcher:match_body(body, BODY_MATCH) -- Matching body with List with and conditions
        if resp.status ~= 200 then return end
        if body_match then send_report(resp) end
    end
end

function main()
    http:set_redirects(2) -- max redirects 2
    scan_cve("MicroStrategyWS/happyaxis.jsp")
end

