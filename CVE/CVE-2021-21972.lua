-- AUTHOR: Mohamed Tarek @0xr00t3d
-- Reference: https://swarm.ptsecurity.com/unauth-rce-vmware/

SCAN_TYPE = 2

ENDPOINTS = {
    "ui/vropspluginui/rest/services/getstatus"
}

function main()
    for _, path in pairs(ENDPOINTS) do
        local new_url = HttpMessage:urljoin(path)
        local status, resp = pcall(function()
            return http:send { url = new_url }
        end)

        local body = resp["body"]

        if resp.status == 200
            and resp.headers["vsphere-ui-jsessionid"] ~= nil
            and Matcher:is_match("(Install|Config) Final Progress", body)
        then
            Reports:add {
                name = "[CVE-2021-21972] VMware vCenter Unauthenticated RCE",
                url = new_url,
                risk = "Critical",
                matches = {
                    status_code = 200,
                    http_header = "VSPHERE-UI-JSESSIONID",
                    body = "(Install|Config) Final Progress"
                }
            }
        end
    end
end
