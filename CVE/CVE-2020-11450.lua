SCAN_TYPE = 3
BODY_MATCH = {
    'Axis2 Happiness Page',
    'Examining webapp configuration',
    'Essential Components'
}

local function send_report(url)
    CveReport:setName("CVE-2020-11450")
    CveReport:setDescription("MicroStrategy Web 10.4 is susceptible to information disclosure. The JVM configuration, CPU architecture, installation folder, and other information are exposed through /MicroStrategyWS/happyaxis.jsp. An attacker can use this vulnerability to learn more about the application environment and thereby possibly obtain sensitive information, modify data, and/or execute unauthorized operations.")
    CveReport:setRisk("high")
    CveReport:setUrl(url)
    Reports:addCveReport(CveReport)
    print_cve_report(CveReport)
end

function scan_cve(target_path)
    local new_path = pathjoin(HttpMessage:Path(),target_path)
    local new_url = HttpMessage:urlJoin(new_path)
    local resp_status, resp = pcall(function ()
        return http:send("GET", new_url)
    end)
    if resp_status == true then
        local url = resp.url
        local body = resp.body
        local body_match = ResponseMatcher:match_body(body,BODY_MATCH) -- Matching body with List with and conditions
        if resp.status ~= 200 then 
            return
        end
        if body_match then 
            for _,match_txt in ipairs(BODY_MATCH) do
                CveReport:addMatcher(match_txt,3)  -- 3 = response body
            end
            CveReport:addMatcher("200",4)  -- 4 = response status
            send_report(url)
        end
    end
end

function main()
    http:set_redirects(2) -- max redirects 2
    scan_cve("MicroStrategyWS/happyaxis.jsp")
end
